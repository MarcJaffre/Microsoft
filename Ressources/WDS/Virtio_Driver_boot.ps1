############################################################################################################################
# Injecter le pilote Virtio dans l'image boot.wim #
###################################################

############################################################################################################################
# Nettoyage Console #
#####################
clear-host

############################################################################################################################
# Emplacement de Montage #
##########################
$MOUNT         = "C:\Mount"

############################################################################################################################
# Boot.wim #
############
$DOSSIER       = "D:\Ressources\Tool\ESD 2 WIM"
$FILE          = "boot.wim"
$INDEX         = "1"

############################################################################################################################
# Pilote #
##########
$DRIVER_FOLDER = "C:\Users\Administrateur\Downloads\virtio-win-0.1.271\NetKVM\w10\amd64"
$DRIVER_FILE   = "netkvm.inf" 

############################################################################################################################
# Creation du Dossier #
#######################
if (-not (Test-Path "$MOUNT")) { New-Item -Path "$MOUNT" -ItemType Directory }

############################################################################################################################
# Verifier si le dossier n'est pas vide #
#########################################
if ((Get-ChildItem "$MOUNT" -ErrorAction SilentlyContinue).Count -ne 0) {
    dism /Unmount-Wim /MountDir:"$MOUNT" /discard
    Write-Output "Le dossier n'est pas vide."
}

############################################################################################################################
# Montage Index sur le syst√®me #
################################
dism /Mount-Wim /WimFile:"$DOSSIER\$FILE" /index:$INDEX /MountDir:"$MOUNT"

############################################################################################################################
# Injection du Pilote #
#######################
dism /Image:"$MOUNT" /Add-Driver /Driver:"$DRIVER_FOLDER\$DRIVER_FILE" /Recurse

############################################################################################################################
# Appliquer les modifications #
###############################
dism /Unmount-Wim /MountDir:"$MOUNT" /Commit
